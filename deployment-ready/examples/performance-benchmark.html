<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperGPU Engine 性能基准测试</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h3 { color: #569cd6; margin-top: 0; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1177bb; }
        .results {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f44747; }
        .info { color: #9cdcfe; }
        .perf-target { color: #569cd6; font-weight: bold; }
        .perf-result { font-size: 18px; margin: 5px 0; }
        .speedup { font-weight: bold; font-size: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #569cd6; text-align: center;">⚡ HyperGPU Engine 性能基准测试</h1>
        
        <div class="section">
            <h3>📊 性能目标 (HyperGPU vs 纯JavaScript)</h3>
            <div class="perf-target">
                • 向量归一化性能提升: <span style="color: #dcdcaa;">10x</span><br>
                • 矩阵乘法性能提升: <span style="color: #dcdcaa;">13x</span><br>
                • 图像处理性能提升: <span style="color: #dcdcaa;">12x</span><br>
                • 粒子模拟性能提升: <span style="color: #dcdcaa;">16x</span>
            </div>
        </div>

        <div class="section">
            <h3>🧪 基准测试控制</h3>
            <button onclick="runVectorBenchmark()">🔍 向量归一化基准测试</button>
            <button onclick="runMatrixBenchmark()">📐 矩阵乘法基准测试</button>
            <button onclick="runMemoryBenchmark()">💾 内存管理基准测试</button>
            <button onclick="runBatchBenchmark()">⚡ 批处理性能测试</button>
            <button onclick="runComprehensiveBenchmark()">🚀 综合性能测试</button>
            <button onclick="clearResults()">🗑️ 清除结果</button>
        </div>

        <div class="section">
            <h3>📈 基准测试结果</h3>
            <div id="results" class="results">
                <div class="info">点击上方按钮开始性能测试...</div>
            </div>
        </div>
    </div>

    <!-- 加载引擎 -->
    <script src="./src/engine/hypergpu-engine-test.js"></script>
    <script src="./src/testing/unit-tests.js"></script>

    <script>
        function log(level, message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toISOString().slice(11, 23);
            const div = document.createElement('div');
            div.className = level;
            div.innerHTML = `[${timestamp}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // 纯JavaScript基准实现
        const pureJSBenchmarks = {
            normalizeVector: (vector) => {
                const len = Math.sqrt(vector.reduce((sum, v) => sum + v * v, 0));
                return len > 0 ? vector.map(v => v / len) : vector;
            },
            
            multiplyMatrix: (a, b) => {
                const result = new Array(16).fill(0);
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        for (let k = 0; k < 4; k++) {
                            result[i * 4 + j] += a[i * 4 + k] * b[k * 4 + j];
                        }
                    }
                }
                return result;
            }
        };

        async function runVectorBenchmark() {
            log('info', '🔍 开始向量归一化基准测试...');
            
            const iterations = 10000;
            const testVectors = Array.from({length: iterations}, () => [
                Math.random() * 100, Math.random() * 100, Math.random() * 100
            ]);

            try {
                // 纯JavaScript基准
                log('info', `执行 ${iterations} 次纯JavaScript向量归一化...`);
                const jsStart = performance.now();
                for (const vector of testVectors) {
                    pureJSBenchmarks.normalizeVector(vector);
                }
                const jsTime = performance.now() - jsStart;

                // HyperGPU测试
                if (typeof ModuleLoader !== 'undefined') {
                    const wasmCore = ModuleLoader.inject('wasmCore');
                    log('info', `执行 ${iterations} 次HyperGPU向量归一化...`);
                    const hyperStart = performance.now();
                    for (const vector of testVectors) {
                        wasmCore.normalizeVectorGeneric(vector);
                    }
                    const hyperTime = performance.now() - hyperStart;

                    const speedup = jsTime / hyperTime;
                    const targetMet = speedup >= 10;

                    log('success', `📊 向量归一化基准测试完成:`);
                    log('info', `   • 纯JavaScript: ${jsTime.toFixed(2)}ms (${(iterations/jsTime*1000).toFixed(0)} ops/sec)`);
                    log('info', `   • HyperGPU: ${hyperTime.toFixed(2)}ms (${(iterations/hyperTime*1000).toFixed(0)} ops/sec)`);
                    log(targetMet ? 'success' : 'warning', 
                        `   • <span class="speedup">性能提升: ${speedup.toFixed(2)}x</span> ${targetMet ? '✅ 达标' : '⚠️ 未达标'} (目标: 10x)`);
                } else {
                    log('error', '❌ HyperGPU引擎未加载，无法进行对比测试');
                }
            } catch (error) {
                log('error', `❌ 向量归一化基准测试失败: ${error.message}`);
            }
        }

        async function runMatrixBenchmark() {
            log('info', '📐 开始矩阵乘法基准测试...');
            
            const iterations = 1000;
            const matrices = Array.from({length: iterations}, () => ({
                a: Array.from({length: 16}, () => Math.random()),
                b: Array.from({length: 16}, () => Math.random())
            }));

            try {
                // 纯JavaScript基准
                log('info', `执行 ${iterations} 次纯JavaScript矩阵乘法...`);
                const jsStart = performance.now();
                for (const {a, b} of matrices) {
                    pureJSBenchmarks.multiplyMatrix(a, b);
                }
                const jsTime = performance.now() - jsStart;

                // HyperGPU测试
                if (typeof ModuleLoader !== 'undefined') {
                    const wasmCore = ModuleLoader.inject('wasmCore');
                    log('info', `执行 ${iterations} 次HyperGPU矩阵乘法...`);
                    const hyperStart = performance.now();
                    for (const {a, b} of matrices) {
                        wasmCore.multiplyMat4Generic(a, b);
                    }
                    const hyperTime = performance.now() - hyperStart;

                    const speedup = jsTime / hyperTime;
                    const targetMet = speedup >= 13;

                    log('success', `📊 矩阵乘法基准测试完成:`);
                    log('info', `   • 纯JavaScript: ${jsTime.toFixed(2)}ms (${(iterations/jsTime*1000).toFixed(0)} ops/sec)`);
                    log('info', `   • HyperGPU: ${hyperTime.toFixed(2)}ms (${(iterations/hyperTime*1000).toFixed(0)} ops/sec)`);
                    log(targetMet ? 'success' : 'warning', 
                        `   • <span class="speedup">性能提升: ${speedup.toFixed(2)}x</span> ${targetMet ? '✅ 达标' : '⚠️ 未达标'} (目标: 13x)`);
                } else {
                    log('error', '❌ HyperGPU引擎未加载，无法进行对比测试');
                }
            } catch (error) {
                log('error', `❌ 矩阵乘法基准测试失败: ${error.message}`);
            }
        }

        async function runMemoryBenchmark() {
            log('info', '💾 开始内存管理基准测试...');
            
            try {
                const initialMemory = HyperGpuUtils.getMemoryInfo();
                log('info', `初始内存: ${initialMemory.used}MB / ${initialMemory.total}MB`);

                const iterations = 5000;
                const largeVectors = Array.from({length: iterations}, () => 
                    Array.from({length: 100}, () => Math.random())
                );

                log('info', `执行 ${iterations} 次大向量处理 (内存压力测试)...`);
                const memStart = performance.now();
                
                if (typeof ModuleLoader !== 'undefined') {
                    const wasmCore = ModuleLoader.inject('wasmCore');
                    for (const vector of largeVectors) {
                        wasmCore.normalizeVectorGeneric(vector);
                    }
                } else {
                    throw new Error('HyperGPU引擎未加载');
                }

                const memTime = performance.now() - memStart;
                const finalMemory = HyperGpuUtils.getMemoryInfo();
                const memoryDelta = finalMemory.used - initialMemory.used;

                log('success', `📊 内存管理基准测试完成:`);
                log('info', `   • 处理时间: ${memTime.toFixed(2)}ms`);
                log('info', `   • 内存变化: ${memoryDelta > 0 ? '+' : ''}${memoryDelta}MB`);
                log('info', `   • 最终内存: ${finalMemory.used}MB / ${finalMemory.total}MB (${((finalMemory.used/finalMemory.total)*100).toFixed(1)}%)`);
                log(memoryDelta < 50 ? 'success' : 'warning', 
                    `   • 内存效率: ${memoryDelta < 50 ? '✅ 优秀' : memoryDelta < 100 ? '⚠️ 良好' : '❌ 需要优化'}`);
            } catch (error) {
                log('error', `❌ 内存管理基准测试失败: ${error.message}`);
            }
        }

        async function runBatchBenchmark() {
            log('info', '⚡ 开始批处理性能测试...');
            
            const vectorCount = 100;
            const testVectors = Array.from({length: vectorCount}, () => [
                Math.random() * 10, Math.random() * 10, Math.random() * 10
            ]);

            try {
                if (typeof ModuleLoader !== 'undefined') {
                    const wasmCore = ModuleLoader.inject('wasmCore');
                    
                    // 单个处理
                    log('info', '测试单个向量处理...');
                    const singleStart = performance.now();
                    for (const vector of testVectors) {
                        wasmCore.normalizeVectorGeneric(vector);
                    }
                    const singleTime = performance.now() - singleStart;

                    // 模拟批处理（连续处理）
                    log('info', '测试批量向量处理...');
                    const batchStart = performance.now();
                    // 批处理优化：减少函数调用开销
                    const batchResults = testVectors.map(vector => 
                        wasmCore.normalizeVectorGeneric(vector)
                    );
                    const batchTime = performance.now() - batchStart;

                    const batchSpeedup = singleTime / batchTime;

                    log('success', `📊 批处理性能测试完成:`);
                    log('info', `   • 单个处理: ${singleTime.toFixed(2)}ms`);
                    log('info', `   • 批量处理: ${batchTime.toFixed(2)}ms`);
                    log('info', `   • <span class="speedup">批处理提升: ${batchSpeedup.toFixed(2)}x</span>`);
                    log(batchSpeedup > 1.2 ? 'success' : 'warning', 
                        `   • 批处理效果: ${batchSpeedup > 1.2 ? '✅ 有效' : '⚠️ 一般'}`);
                } else {
                    log('error', '❌ HyperGPU引擎未加载');
                }
            } catch (error) {
                log('error', `❌ 批处理性能测试失败: ${error.message}`);
            }
        }

        async function runComprehensiveBenchmark() {
            log('info', '🚀 开始综合性能测试...');
            log('info', '='.repeat(60));

            // 运行所有基准测试
            await runVectorBenchmark();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runMatrixBenchmark();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runMemoryBenchmark();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await runBatchBenchmark();

            log('success', '🎉 综合性能测试完成!');
            log('info', '='.repeat(60));
        }

        function clearResults() {
            document.getElementById('results').innerHTML = 
                '<div class="info">结果已清除，点击按钮开始新的测试...</div>';
        }

        // 页面加载完成后自动检查环境
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('info', '🚀 HyperGPU Engine 性能基准测试工具已加载');
                
                if (typeof ModuleLoader !== 'undefined') {
                    log('success', '✅ HyperGPU Engine 已准备就绪');
                    log('info', '💡 点击上方按钮开始性能基准测试');
                } else {
                    log('warning', '⚠️ HyperGPU Engine 未完全加载，部分测试可能不可用');
                }
            }, 1000);
        });
    </script>
</body>
</html>